const cookies = [
    {
        "domain": ".youtube.com",
        "expirationDate": 1740619437.876667,
        "hostOnly": false,
        "httpOnly": true,
        "name": "VISITOR_PRIVACY_METADATA",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "CgJQSxIEGgAgUA%3D%3D"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1733414518,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_gcl_au",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "1.1.1105463588.1725638518"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.717814,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "g.a000oQifhvNNaTokPX3vw7P_BjmZOyQc5xqmXyA7EXp9NJtVtHq_V8WWokvH9YYeaeVLf6ln2gACgYKAVASARUSFQHGX2MiSVbSPkQhuggyoA45yKV4GhoVAUF8yKqJjz3oPtToTP_hj6L8s0em0076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1758442191.49942,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SIDCC",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "AKEyXzXJ_qcD2__fNt3h2zOQRRJ4MnQ9-fbpEX26LkaLXr5eiMvOJloRj587vFbnR8IknOjz7Q"
    },
    {
        "domain": ".youtube.com",
        "hostOnly": false,
        "httpOnly": true,
        "name": "YSC",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "jpMvA9hRufM"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.717282,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "g.a000oQifhvNNaTokPX3vw7P_BjmZOyQc5xqmXyA7EXp9NJtVtHq_w9wXSnk3lQPekIEx6QE2mQACgYKAT8SARUSFQHGX2MiWUiMwcTCuuZLGcSOcXigYBoVAUF8yKpMmeBszKyVM1xNfxCy7pfy0076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1758442007.085142,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSIDTS",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "sidts-CjEBQlrA-KG_D65KWh1jHCTBZzBD-5JUkcAJJhCxtOjNEOs4858LyEDPA7sxP8g8sWYvEAA"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.71868,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SAPISID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "aCbCQ9YrWe-CVeHC/A0aKkRWMmnlQvShQz"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1758442191.499619,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSIDCC",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AKEyXzV9GnrCL-3qDYaf6goM36Ue7GJfwENjk-8TkXuMNP4-ylBL0rduu_FmHetVT0BMX8NwHds"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.718208,
        "hostOnly": false,
        "httpOnly": true,
        "name": "SSID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "Aq0c3sB1-f8tdwJMV"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.718797,
        "hostOnly": false,
        "httpOnly": false,
        "name": "__Secure-1PAPISID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "aCbCQ9YrWe-CVeHC/A0aKkRWMmnlQvShQz"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.717704,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "g.a000oQifhvNNaTokPX3vw7P_BjmZOyQc5xqmXyA7EXp9NJtVtHq_zJln20xqu0IbVao7925QxwACgYKAc4SARUSFQHGX2MicQS8b78B5dOqNLsaXgPwihoVAUF8yKrFlnTr--uKzNwsx87znYY30076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.7189,
        "hostOnly": false,
        "httpOnly": false,
        "name": "__Secure-3PAPISID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "aCbCQ9YrWe-CVeHC/A0aKkRWMmnlQvShQz"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1758442191.499734,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSIDCC",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AKEyXzU3kRVaLN0H9UpuOLjI0jyCMAqAuvu4PxM7PScBiCCW6F0Wb_3SZCNq0F80bhxJgjzNnn4"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1758442007.085289,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSIDTS",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "sidts-CjEBQlrA-KG_D65KWh1jHCTBZzBD-5JUkcAJJhCxtOjNEOs4858LyEDPA7sxP8g8sWYvEAA"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1760969484.582328,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_ga",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "GA1.1.911662981.1726409147"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1760969502.791636,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_ga_VCGEPY40VB",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "GS1.1.1726409146.1.1.1726409502.40.0.0"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.718424,
        "hostOnly": false,
        "httpOnly": false,
        "name": "APISID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "MeMQEpE7PzG4NQnQ/APbsJ8AXhS1Hb3pyc"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761464226.717924,
        "hostOnly": false,
        "httpOnly": true,
        "name": "HSID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "Ac92P1K6-UAiMJuxG"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1760969482.60642,
        "hostOnly": false,
        "httpOnly": true,
        "name": "LOGIN_INFO",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AFmmF2swRAIgCALJKQucKIH6IiJR0XAC2tUL3WU37QzpwZ0zbDtzlQ0CIGqQZ4QcYSV9DJ-IWXFBUA_Itp1_ex9mRoAVMJ1qtx71:QUQ3MjNmeTNGaXpON25xMmZDdW9qVkRHMWVTM1JhMnVvNWhoMzhRbFBITGJVZXBNR3ZCMFpkUU9USHktaHgzT1dydUNhTTBTZWNKOUJ3NVA1V0o2WmZpQ2tKd1RHUTNkclppd2VaaW9kNWxidkxwTmYwa0YyNDdkb0Q3VThUZFZJRGduVG5YMkpLajJydmlEZmg0YUFrZEtkcFRHWkxRNlRn"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1742220350.498699,
        "hostOnly": false,
        "httpOnly": true,
        "name": "NID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "517=Fh_gRvLRWb6u9vNJXcPUJkoi2w4gN4noeXRr_fHeE7dLeCHMnU7ZSHgfAXwnsJyPAXv93fiL6t3raFhkdl5_kApni4n_MWu5NL_JYc8JS7-v8p40d1HycNFk3UwWW94s5A-g6MWDjdBA-aKqeZBTilwbtWr0g0QDO7agFnw2dlx-X-JDGChO_ei-m61Aji8BtFYHY5HKsU8sc0rdQYA9N2O2JKKUFl5CbcmteStsRnfTj8baPw"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761466008.680758,
        "hostOnly": false,
        "httpOnly": false,
        "name": "PREF",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "volume=47&f6=40000080&f7=100&tz=Asia.Karachi&repeat=NONE&autoplay=true&f4=4000000"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1740619437.876593,
        "hostOnly": false,
        "httpOnly": true,
        "name": "VISITOR_INFO1_LIVE",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "kuMBp9yZ4WE"
    }
]
import ytdl from '@distube/ytdl-core';
import fs from 'fs';
import path from 'path';
import { pipeline } from 'stream';
import { promisify } from 'util';

const agent = ytdl.createAgent(cookies);
const streamPipeline = promisify(pipeline);

export const getYtInfo = async (req, res) => {
    let { url, quality } = req.query;

    if (!url) {
        return res.status(400).json({ status: 400, message: 'URL is required.' });
    }

    try {
        let infoYt = await ytdl.getInfo(url, { agent });
       
        let videoId = infoYt.videoDetails.videoId;
        
        if (!quality) quality = '128'; 

        const format = infoYt.formats
            .filter(el => el.hasAudio && !el.hasVideo && el.audioBitrate >= quality)
            .slice(-1)[0]; 

        if (!format) {
            return res.status(400).json({ msg: 'No matching audio quality found.' });
        }
     
        const downloadsDir = path.resolve('downloads');
        if (!fs.existsSync(downloadsDir)) {
            fs.mkdirSync(downloadsDir);
        }

        const file = path.resolve(downloadsDir, `${videoId}.mp3`);

       
        const oldFiles = fs.readdirSync(downloadsDir);
        if (oldFiles.includes(`${videoId}.mp3`)) {
           return res.sendFile(file);
        }


        const stream = ytdl(url, { agent, format });
     
        await streamPipeline(stream, fs.createWriteStream(file));

        res.sendFile(file);

        // Cleanup: Remove the file after 1 hour
        setTimeout(() => {
            if (fs.existsSync(file)) fs.unlinkSync(file);
        }, 1 * 60 * 60 * 1000); // 1 hour

    } catch (error) {
        console.error('Error:', error);
        res.status(500).json({ status: 500, message: 'An error occurred.', error: error.message });
    }
};